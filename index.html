<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Thollio Holzmantelerfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- XLSX f√ºr Excel-Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #1e2421;
    color: #e0e3de;
    margin: 10px;
    -webkit-tap-highlight-color: transparent;
  }

  h1 {
    text-align: center;
    color: #c4f0c2;
    margin-bottom: 25px;
    font-size: 1.6em;
  }

  form, .ergebnis {
    background: #2a2f2c;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    max-width: 900px;
    margin: 0 auto 30px auto;
  }

  label { display: block; margin-top: 12px; color: #c9d1c5; font-size: 1.1em; }

  input, select, textarea, button {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid #555;
    margin-top: 6px;
    background-color: #3b423e;
    color: #f1f1f1;
    font-size: 1.1em;
    box-sizing: border-box;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #66bb6a;
    background-color: #454d49;
  }

  textarea { resize: vertical; min-height: 70px; }

  button {
    background-color: #36643b;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 18px;
    font-size: 1.2em;
    transition: background 0.3s ease;
    padding: 16px;
    border-radius: 12px;
  }

  button:hover { background-color: #2d5333; }

  #map {
    height: 300px;
    width: 100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #343b37;
  }

  th, td {
    border: 1px solid #555;
    padding: 10px;
    text-align: center;
    font-size: 1.1em;
  }

  th { background-color: #425046; color: #e4efe1; }

  .summe {
    font-weight: bold;
    background-color: #506350;
  }

  .btn-export { background-color: #245a7a; }
  .btn-export:hover { background-color: #1d495f; }

  .btn-reset { background-color: #7a2424; }
  .btn-reset:hover { background-color: #5f1d1d; }

  #durchschnittAnzeige {
    margin-top: 8px;
    font-weight: bold;
    color: #a5d6a7;
    font-size: 1.1em;
  }

  /* üì± Mobile Optimierung */
  @media (max-width: 600px) {
    body {
      margin: 5px;
      font-size: 1.1em;
    }

    h1 { font-size: 1.4em; }

    input, select, textarea, button {
      font-size: 1.2em;
      padding: 16px;
    }

    #map {
      height: 250px;
    }

    button {
      font-size: 1.2em;
      padding: 18px;
    }
  }
</style>
</head>

<body>
<h1>Thollio Holzmantelerfassung</h1>

<form id="holzForm">
  <label>Datum:
    <input type="date" id="datum" required>
  </label>

  <label>Baumart:
    <select id="baumart" required>
      <option value="">Bitte w√§hlen...</option>
      <option>Fichte</option><option>Wei√ütanne</option><option>Douglasie</option>
      <option>L√§rche</option><option>Kiefer</option><option>SNH</option><option>SLB</option>
      <option>Eiche</option><option>Buche</option><option>Ahorn</option>
      <option>Esche</option><option>Kirsche</option><option>Erle</option>
    </select>
  </label>

  <label>G√ºteklasse:
    <select id="gueteklasse" required>
      <option value="">Bitte w√§hlen...</option>
      <option>A</option><option>B</option><option>C</option><option>D</option>
      <option>BC</option><option>BK</option><option>CK</option>
      <option>CD</option><option>N</option><option>NF</option><option>K</option>
    </select>
  </label>

  <label>Polternummer:
    <input type="text" id="polternummer" required>
  </label>

  <label>Hiebnummer:
    <input type="text" id="hiebnummer" required>
  </label>

  <label>Losnummer:
    <input type="text" id="losnummer" required>
  </label>

  <label>L√§nge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <h3>Standort (OpenStreetMap)</h3>
  <div id="map"></div>
  <input type="hidden" id="latitude">
  <input type="hidden" id="longitude">

  <h3>Durchmesser eingeben (Enter nach jedem Wert)</h3>
  <input type="number" id="durchmesserEingabe" placeholder="Durchmesser (cm)" step="0.1" required>
  <div id="durchmesserListe"></div>
  <div id="durchschnittAnzeige">Durchschnitt: -</div>

  <button type="button" onclick="zeigeGesamtStueckzahl()">Gesamtst√ºckzahl eingeben</button>

  <div id="anzahlContainer" style="display:none; margin-top:20px;">
    <label>Gesamtst√ºckzahl:
      <input type="number" id="gesamtAnzahl" min="1" required>
    </label>

    <label>Bemerkung:
      <textarea id="bemerkung" placeholder="z. B. Hanglage, feucht, besch√§digt ..."></textarea>
    </label>

    <button type="submit">Berechnen</button>
  </div>

  <button type="button" class="btn-reset" onclick="allesLoeschen()">Alles l√∂schen</button>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <table id="ergebnisTabelle">
    <thead>
      <tr>
        <th>Durchschnitt (cm)</th>
        <th>Gesamtst√ºckzahl</th>
        <th>Einzelvolumen (m¬≥)</th>
        <th>Gesamtvolumen (m¬≥)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="summe">
        <td colspan="3">Gesamtvolumen</td>
        <td id="gesamtVolumen">0.000</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center; margin-top:15px;">
    <button class="btn-export" onclick="exportXLSX()">Excel (.xlsx) exportieren</button>
  </div>
</div>

<script>
let durchmesserListe = [];
let map, marker;
const dInput = document.getElementById("durchmesserEingabe");
const avgAnzeige = document.getElementById("durchschnittAnzeige");
const KEYS = ["datum","baumart","gueteklasse","polternummer","hiebnummer","losnummer","laenge","latitude","longitude","bemerkung"];

/* üå≤ Beim Laden: gespeicherte Werte setzen + Standardwert f√ºr Durchmesser + aktuelles Datum */
window.addEventListener("load", () => {
  KEYS.forEach(k => {
    const val = localStorage.getItem("thollio_" + k);
    const el = document.getElementById(k);
    if (el && val) el.value = val;
  });

  // üîπ Aktuelles Datum automatisch setzen, falls leer
  const datumInput = document.getElementById("datum");
  if (!datumInput.value) {
    const heute = new Date();
    datumInput.value = heute.toISOString().split("T")[0];
  }

  // Letzten Durchmesserwert laden oder Standardwert 20 setzen
  const lastD = localStorage.getItem("thollio_lastDurchmesser");
  dInput.value = lastD ? lastD : 20;

  dInput.focus();
  initMap();
});

function initMap() {
  map = L.map('map').setView([51.1657, 10.4515], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  marker = L.marker([51.1657, 10.4515]).addTo(map);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 16);
      marker.setLatLng([latitude, longitude]);
      marker.bindPopup(`<b>üìç Aktueller Standort:</b><br>${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
        <a href="https://maps.google.com/?q=${latitude},${longitude}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
      setCoords(latitude, longitude);
    }, () => {
      marker.bindPopup(`<b>üìç Standard-Standort (Deutschland):</b><br>51.1657, 10.4515`).openPopup();
      setCoords(51.1657, 10.4515);
    });
  }

  map.on('click', e => {
    const { lat, lng } = e.latlng;
    setCoords(lat, lng);
    marker.setLatLng([lat, lng]);
    marker.bindPopup(`<b>üìç Standort:</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
    <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
  });
}

function setCoords(lat, lon){
  document.getElementById("latitude").value = lat.toFixed(6);
  document.getElementById("longitude").value = lon.toFixed(6);
  localStorage.setItem("thollio_latitude", lat.toFixed(6));
  localStorage.setItem("thollio_longitude", lon.toFixed(6));
}
</script>
</body>
</html>
