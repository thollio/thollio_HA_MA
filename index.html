<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Thollio Holzmantelerfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: #e0e0e0;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #b3ffb3;
    }
    form, .ergebnis {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      max-width: 900px;
      margin: 0 auto 30px auto;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button, textarea {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #3a3a3a;
      color: #e0e0e0;
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
    }
    button {
      background-color: #357a38;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #2b612e;
    }
    #map {
      height: 300px;
      margin-top: 10px;
      border-radius: 8px;
    }
    .durchmesser-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-export {
      background-color: #1565c0;
    }
    .btn-export:hover {
      background-color: #0d47a1;
    }
    .btn-delete {
      background-color: #a32b2b;
    }
    .btn-delete:hover {
      background-color: #7a1f1f;
    }
  </style>
</head>
<body>

<h1>Thollio Holzmantelerfassung</h1>

<form id="holzForm">
  <label>Datum:
    <input type="date" id="datum" required>
  </label>

  <label>Baumart:
    <select id="baumart" required>
      <option value="">Bitte w√§hlen</option>
      <option>Fichte</option>
      <option>Wei√ütanne</option>
      <option>Douglasie</option>
      <option>L√§rche</option>
      <option>Kiefer</option>
      <option>SNH</option>
      <option>SLB</option>
      <option>Eiche</option>
      <option>Buche</option>
      <option>Ahorn</option>
      <option>Esche</option>
      <option>Kirsche</option>
      <option>Erle</option>
    </select>
  </label>

  <label>G√ºteklasse:
    <select id="gueteklasse" required>
      <option value="">Bitte w√§hlen</option>
      <option>A</option><option>B</option><option>C</option><option>D</option>
      <option>BC</option><option>BK</option><option>CK</option>
      <option>CD</option><option>N</option><option>F</option>
    </select>
  </label>

  <label>Hiebnummer:
    <input type="text" id="hiebnummer" required>
  </label>
  <label>Losnummer:
    <input type="text" id="losnummer" required>
  </label>
  <label>Polternummer:
    <input type="text" id="polternummer" required>
  </label>

  <label>L√§nge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <label>Bemerkung:
    <textarea id="bemerkung" rows="2" placeholder="Optionale Anmerkung..."></textarea>
  </label>

  <h3>Standort</h3>
  <div id="map"></div>
  <button type="button" id="updateLocation">üìç Standort aktualisieren</button>
  <input type="hidden" id="latitude">
  <input type="hidden" id="longitude">

  <h3>Durchmesser eingeben</h3>
  <div class="durchmesser-container">
    <input type="number" id="durchmesserInput" placeholder="Durchmesser (cm)" step="0.1">
    <button type="button" id="addDurchmesser">+</button>
  </div>
  <div id="durchmesserListe"></div>

  <label>Gesamtst√ºckzahl:
    <input type="number" id="gesamtstueckzahl" min="1" required>
  </label>

  <button type="submit">Berechnen</button>
  <button type="button" class="btn-delete" id="allesLoeschen">Alles l√∂schen</button>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <p><b>Durchschnittsdurchmesser:</b> <span id="avgD"></span> cm</p>
  <p><b>Einzelvolumen:</b> <span id="einzelVol"></span> m¬≥</p>
  <p><b>Gesamtvolumen:</b> <span id="gesamtVol"></span> m¬≥</p>
  <button class="btn-export" id="exportXLSX">Excel (.xlsx) exportieren</button>
</div>

<script>
const L_KEYS = {
  laenge: "holz_laenge",
  datum: "holz_datum",
  baumart: "holz_baumart",
  guete: "holz_guete",
  hieb: "holz_hieb",
  los: "holz_los",
  polter: "holz_polter",
  bemerkung: "holz_bemerkung",
  lat: "holz_lat",
  lon: "holz_lon"
};

const durchmesserInput = document.getElementById("durchmesserInput");
const durchmesserListe = [];
const durchmesserContainer = document.getElementById("durchmesserListe");
let map, marker;

// Letzte Eingaben laden
window.addEventListener("load", () => {
  document.getElementById("laenge").value = localStorage.getItem(L_KEYS.laenge) || "";
  document.getElementById("datum").value = localStorage.getItem(L_KEYS.datum) || new Date().toISOString().split("T")[0];
  document.getElementById("baumart").value = localStorage.getItem(L_KEYS.baumart) || "";
  document.getElementById("gueteklasse").value = localStorage.getItem(L_KEYS.guete) || "";
  document.getElementById("hiebnummer").value = localStorage.getItem(L_KEYS.hieb) || "";
  document.getElementById("losnummer").value = localStorage.getItem(L_KEYS.los) || "";
  document.getElementById("polternummer").value = localStorage.getItem(L_KEYS.polter) || "";
  document.getElementById("bemerkung").value = localStorage.getItem(L_KEYS.bemerkung) || "";

  initMap();
  const lat = parseFloat(localStorage.getItem(L_KEYS.lat));
  const lon = parseFloat(localStorage.getItem(L_KEYS.lon));
  if (!isNaN(lat) && !isNaN(lon)) setMarker(lat, lon);
});

function initMap() {
  map = L.map('map').setView([51.1657, 10.4515], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(map);
}

function setMarker(lat, lon) {
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lon]).addTo(map);
  map.setView([lat, lon], 15);
  document.getElementById("latitude").value = lat;
  document.getElementById("longitude").value = lon;
}

document.getElementById("updateLocation").addEventListener("click", () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    setMarker(lat, lon);
    localStorage.setItem(L_KEYS.lat, lat);
    localStorage.setItem(L_KEYS.lon, lon);
  });
});

document.getElementById("addDurchmesser").addEventListener("click", () => {
  const val = parseFloat(durchmesserInput.value);
  if (!isNaN(val)) {
    durchmesserListe.push(val);
    const p = document.createElement("p");
    p.textContent = val.toFixed(1) + " cm";
    durchmesserContainer.appendChild(p);
    durchmesserInput.value = val; // letzten Wert √ºbernehmen
    durchmesserInput.focus();
  }
});

document.getElementById("holzForm").addEventListener("submit", e => {
  e.preventDefault();

  const avgD = durchmesserListe.reduce((a,b)=>a+b,0) / durchmesserListe.length || 0;
  const stueck = parseInt(document.getElementById("gesamtstueckzahl").value);
  const laenge = parseFloat(document.getElementById("laenge").value);
  const einzelVol = Math.PI * Math.pow(avgD / 200, 2) * laenge;
  const gesamtVol = einzelVol * stueck;

  document.getElementById("avgD").textContent = avgD.toFixed(1);
  document.getElementById("einzelVol").textContent = einzelVol.toFixed(3);
  document.getElementById("gesamtVol").textContent = gesamtVol.toFixed(3);
  document.getElementById("ergebnis").style.display = "block";

  // Speichern letzter Eingaben
  localStorage.setItem(L_KEYS.laenge, laenge);
  localStorage.setItem(L_KEYS.datum, document.getElementById("datum").value);
  localStorage.setItem(L_KEYS.baumart, document.getElementById("baumart").value);
  localStorage.setItem(L_KEYS.guete, document.getElementById("gueteklasse").value);
  localStorage.setItem(L_KEYS.hieb, document.getElementById("hiebnummer").value);
  localStorage.setItem(L_KEYS.los, document.getElementById("losnummer").value);
  localStorage.setItem(L_KEYS.polter, document.getElementById("polternummer").value);
  localStorage.setItem(L_KEYS.bemerkung, document.getElementById("bemerkung").value);
});

document.getElementById("allesLoeschen").addEventListener("click", () => {
  if (confirm("Wirklich alles l√∂schen?")) {
    localStorage.clear();
    location.reload();
  }
});

document.getElementById("exportXLSX").addEventListener("click", () => {
  const wb = XLSX.utils.book_new();
  const wsData = [[
    "Datum", "Baumart", "G√ºteklasse", "Hieb", "Los", "Polter",
    "L√§nge (m)", "√ò (cm)", "St√ºckzahl", "Einzelvolumen (m¬≥)",
    "Gesamtvolumen (m¬≥)", "Breite", "L√§nge", "Bemerkung"
  ]];
  wsData.push([
    document.getElementById("datum").value,
    document.getElementById("baumart").value,
    document.getElementById("gueteklasse").value,
    document.getElementById("hiebnummer").value,
    document.getElementById("losnummer").value,
    document.getElementById("polternummer").value,
    document.getElementById("laenge").value,
    document.getElementById("avgD").textContent,
    document.getElementById("gesamtstueckzahl").value,
    document.getElementById("einzelVol").textContent,
    document.getElementById("gesamtVol").textContent,
    document.getElementById("latitude").value,
    document.getElementById("longitude").value,
    document.getElementById("bemerkung").value
  ]);
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Erfassung");
  const date = document.getElementById("datum").value;
  const fileName = `Thollio_${date}_${document.getElementById("hiebnummer").value}_${document.getElementById("losnummer").value}_${document.getElementById("polternummer").value}.xlsx`;
  XLSX.writeFile(wb, fileName);
});
</script>

</body>
</html>





