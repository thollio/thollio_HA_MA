<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Thollio Holzmantelerfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet (OpenStreetMap) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- XLSX f√ºr Excel-Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background-color: #f3f7f2; margin: 20px; color: #333; }
  h1 { text-align: center; margin-bottom: 10px; }
  form, .ergebnis { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto 30px auto; }
  label { display: block; margin-top: 10px; }
  input, select, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-top: 5px; box-sizing: border-box; }
  input, select { width: 100%; }
  button { background-color: #2c7a3f; color: white; border: none; cursor: pointer; margin-top: 15px; }
  button:hover { background-color: #256836; }
  #map { height: 300px; width: 100%; margin-top: 10px; border-radius: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #e6f0e9; }
  .summe { font-weight: bold; background-color: #d8e9d8; }
  .btn-export { background-color: #1d6fa5; }
  .btn-export:hover { background-color: #15577f; }
  #durchschnittAnzeige { margin-top: 5px; font-weight: bold; transition: color 0.3s ease; }
</style>
</head>

<body>
<h1>Thollio Holzmantelerfassung</h1>

<form id="holzForm">
  <label>Datum:
    <input type="date" id="datum" required>
  </label>

  <label>Baumart:
    <select id="baumart" required>
      <option value="">Bitte w√§hlen...</option>
      <option>Fichte</option>
      <option>Wei√ütanne</option>
      <option>Douglasie</option>
      <option>L√§rche</option>
      <option>Kiefer</option>
      <option>SNH</option>
      <option>SLB</option>
      <option>Eiche</option>
      <option>Buche</option>
      <option>Ahorn</option>
      <option>Esche</option>
      <option>Kirsche</option>
      <option>Erle</option>
    </select>
  </label>

  <label>Polternummer:
    <input type="text" id="polternummer" required>
  </label>
  <label>Hiebnummer:
    <input type="text" id="hiebnummer" required>
  </label>
  <label>Losnummer:
    <input type="text" id="losnummer" required>
  </label>

  <label>L√§nge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <h3>Standort ausw√§hlen (OpenStreetMap)</h3>
  <div id="map"></div>
  <input type="hidden" id="latitude">
  <input type="hidden" id="longitude">

  <h3>Durchmesser eingeben (Enter nach jedem Wert)</h3>
  <input type="number" id="durchmesserEingabe" placeholder="Durchmesser (cm)" step="0.1" required>
  <div id="durchmesserListe"></div>
  <div id="durchschnittAnzeige">Durchschnitt: -</div>

  <button type="button" onclick="zeigeGesamtStueckzahl()">Gesamtst√ºckzahl eingeben</button>

  <div id="anzahlContainer" style="display:none; margin-top:20px;">
    <label>Gesamtst√ºckzahl:
      <input type="number" id="gesamtAnzahl" min="1" required>
    </label>
    <button type="submit">Berechnen</button>
  </div>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <table id="ergebnisTabelle">
    <thead>
      <tr>
        <th>Durchschnitt (cm)</th>
        <th>Gesamtst√ºckzahl</th>
        <th>Einzelvolumen (m¬≥)</th>
        <th>Gesamtvolumen (m¬≥)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="summe">
        <td colspan="3">Gesamtvolumen</td>
        <td id="gesamtVolumen">0.000</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center; margin-top:15px;">
    <button class="btn-export" onclick="exportXLSX()">Excel (.xlsx) exportieren</button>
  </div>
</div>

<script>
let durchmesserListe = [];
let map, marker;
const dInput = document.getElementById("durchmesserEingabe");
const avgAnzeige = document.getElementById("durchschnittAnzeige");

// Lokale Speicher-Keys
const KEYS = ["datum", "baumart", "polternummer", "hiebnummer", "losnummer", "laenge", "latitude", "longitude"];

// Letzte Werte laden
window.addEventListener("load", () => {
  KEYS.forEach(k => {
    const val = localStorage.getItem("thollio_" + k);
    if (val) {
      const el = document.getElementById(k);
      if (el) el.value = val;
    }
  });
  dInput.focus();
  initMap();
});

// üó∫Ô∏è Karte mit Marker & Popup
function initMap() {
  const savedLat = parseFloat(localStorage.getItem("thollio_latitude"));
  const savedLon = parseFloat(localStorage.getItem("thollio_longitude"));

  const lat = !isNaN(savedLat) ? savedLat : 51.1657;
  const lon = !isNaN(savedLon) ? savedLon : 10.4515;
  const zoomLevel = !isNaN(savedLat) ? 15 : 7;

  map = L.map('map').setView([lat, lon], zoomLevel);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  marker = L.marker([lat, lon]).addTo(map);
  marker.bindPopup(`üìç Standort: ${lat.toFixed(5)}, ${lon.toFixed(5)}`).openPopup();

  map.on('click', function(e) {
    const { lat, lng } = e.latlng;
    document.getElementById("latitude").value = lat.toFixed(6);
    document.getElementById("longitude").value = lng.toFixed(6);
    localStorage.setItem("thollio_latitude", lat.toFixed(6));
    localStorage.setItem("thollio_longitude", lng.toFixed(6));
    marker.setLatLng([lat, lng]);
    marker.bindPopup(`üìç Standort: ${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();
  });

  document.getElementById("latitude").value = lat.toFixed(6);
  document.getElementById("longitude").value = lon.toFixed(6);
}

dInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    const val = parseFloat(dInput.value);
    if (!isNaN(val)) {
      durchmesserListe.push(val);
      aktualisiereDurchschnitt();
      dInput.value = "";
    }
    dInput.focus();
  }
});

function aktualisiereDurchschnitt() {
  const avg = durchmesserListe.reduce((a,b)=>a+b,0)/durchmesserListe.length;
  if (!isNaN(avg)) {
    window.durchmesserDurchschnitt = avg;
    avgAnzeige.textContent = "Durchschnitt: " + avg.toFixed(1) + " cm";
    avgAnzeige.style.color = "#2c7a3f";
    setTimeout(()=>avgAnzeige.style.color="#333",300);
    document.getElementById("durchmesserListe").textContent = 
      "Eingegebene Durchmesser: " + durchmesserListe.map(d=>d.toFixed(1)).join(", ");
  }
}

function zeigeGesamtStueckzahl() {
  if (durchmesserListe.length === 0) {
    alert("Bitte mindestens einen Durchmesser eingeben.");
    return;
  }
  document.getElementById("anzahlContainer").style.display = "block";
  document.getElementById("gesamtAnzahl").focus();
}

document.getElementById("holzForm").addEventListener("submit", function(e){
  e.preventDefault();

  const data = {};
  KEYS.forEach(k => {
    const el = document.getElementById(k);
    data[k] = el ? el.value : "";
    localStorage.setItem("thollio_" + k, data[k]);
  });

  const laenge = parseFloat(data.laenge);
  const n = parseInt(document.getElementById("gesamtAnzahl").value);
  const d = window.durchmesserDurchschnitt;
  const einzelVol = Math.PI * Math.pow(d/200, 2) * laenge;
  const gesVol = einzelVol * n;

  const tbody = document.querySelector("#ergebnisTabelle tbody");
  tbody.innerHTML = `<tr>
    <td>${d.toFixed(1)}</td>
    <td>${n}</td>
    <td>${einzelVol.toFixed(3)}</td>
    <td>${gesVol.toFixed(3)}</td>
  </tr>`;

  document.getElementById("gesamtVolumen").textContent = gesVol.toFixed(3);
  document.getElementById("ergebnis").style.display = "block";
});

function exportXLSX() {
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ["Thollio Holzmantelerfassung"],
    ["Datum", document.getElementById("datum").value],
    ["Baumart", document.getElementById("baumart").value],
    ["Polternummer", document.getElementById("polternummer").value],
    ["Hiebnummer", document.getElementById("hiebnummer").value],
    ["Losnummer", document.getElementById("losnummer").value],
    ["L√§nge (m)", document.getElementById("laenge").value],
    ["Latitude", document.getElementById("latitude").value],
    ["Longitude", document.getElementById("longitude").value],
    [],
    ["Durchschnitt (cm)", "Gesamtst√ºckzahl", "Einzelvolumen (m¬≥)", "Gesamtvolumen (m¬≥)"]
  ];

  document.querySelectorAll("#ergebnisTabelle tbody tr").forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.textContent);
    ws_data.push(cols);
  });

  ws_data.push(["", "", "Gesamtvolumen", document.getElementById("gesamtVolumen").textContent]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Erfassung");
  XLSX.writeFile(wb, "thollio_holzmantelerfassung.xlsx");
}
</script>
</body>
</html>


