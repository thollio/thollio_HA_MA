<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Thollio Holzmantelerfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- XLSX f√ºr Excel-Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #1e2421;
    color: #e0e3de;
    margin: 20px;
  }

  h1 {
    text-align: center;
    color: #c4f0c2;
    margin-bottom: 25px;
  }

  form, .ergebnis {
    background: #2a2f2c;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    max-width: 900px;
    margin: 0 auto 30px auto;
  }

  label { display: block; margin-top: 10px; color: #c9d1c5; }

  input, select, textarea, button {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #555;
    margin-top: 5px;
    background-color: #3b423e;
    color: #f1f1f1;
    box-sizing: border-box;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #66bb6a;
    background-color: #454d49;
  }

  textarea { resize: vertical; min-height: 60px; }

  button {
    background-color: #36643b;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s ease;
  }

  button:hover { background-color: #2d5333; }

  #map {
    height: 300px;
    width: 100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #343b37;
  }

  th, td {
    border: 1px solid #555;
    padding: 8px;
    text-align: center;
  }

  th { background-color: #425046; color: #e4efe1; }

  .summe {
    font-weight: bold;
    background-color: #506350;
  }

  .btn-export {
    background-color: #245a7a;
  }

  .btn-export:hover { background-color: #1d495f; }

  #durchschnittAnzeige {
    margin-top: 8px;
    font-weight: bold;
    color: #a5d6a7;
  }
</style>
</head>

<body>
<h1>Thollio Holzmantelerfassung</h1>

<form id="holzForm">
  <label>Datum:
    <input type="date" id="datum" required>
  </label>

  <label>Baumart:
    <select id="baumart" required>
      <option value="">Bitte w√§hlen...</option>
      <option>Fichte</option><option>Wei√ütanne</option><option>Douglasie</option>
      <option>L√§rche</option><option>Kiefer</option><option>SNH</option><option>SLB</option>
      <option>Eiche</option><option>Buche</option><option>Ahorn</option>
      <option>Esche</option><option>Kirsche</option><option>Erle</option>
    </select>
  </label>

  <label>Polternummer:
    <input type="text" id="polternummer" required>
  </label>
  <label>Hiebnummer:
    <input type="text" id="hiebnummer" required>
  </label>
  <label>Losnummer:
    <input type="text" id="losnummer" required>
  </label>

  <label>L√§nge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <h3>Standort (OpenStreetMap)</h3>
  <div id="map"></div>
  <input type="hidden" id="latitude">
  <input type="hidden" id="longitude">

  <h3>Durchmesser eingeben (Enter nach jedem Wert)</h3>
  <input type="number" id="durchmesserEingabe" placeholder="Durchmesser (cm)" step="0.1" required>
  <div id="durchmesserListe"></div>
  <div id="durchschnittAnzeige">Durchschnitt: -</div>

  <button type="button" onclick="zeigeGesamtStueckzahl()">Gesamtst√ºckzahl eingeben</button>

  <div id="anzahlContainer" style="display:none; margin-top:20px;">
    <label>Gesamtst√ºckzahl:
      <input type="number" id="gesamtAnzahl" min="1" required>
    </label>

    <label>Bemerkung:
      <textarea id="bemerkung" placeholder="z. B. Hanglage, feucht, besch√§digt ..."></textarea>
    </label>

    <button type="submit">Berechnen</button>
  </div>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <table id="ergebnisTabelle">
    <thead>
      <tr>
        <th>Durchschnitt (cm)</th>
        <th>Gesamtst√ºckzahl</th>
        <th>Einzelvolumen (m¬≥)</th>
        <th>Gesamtvolumen (m¬≥)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="summe">
        <td colspan="3">Gesamtvolumen</td>
        <td id="gesamtVolumen">0.000</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center; margin-top:15px;">
    <button class="btn-export" onclick="exportXLSX()">Excel (.xlsx) exportieren</button>
  </div>
</div>

<script>
let durchmesserListe = [];
let map, marker;
const dInput = document.getElementById("durchmesserEingabe");
const avgAnzeige = document.getElementById("durchschnittAnzeige");
const KEYS = ["datum","baumart","polternummer","hiebnummer","losnummer","laenge","latitude","longitude","bemerkung"];

window.addEventListener("load", () => {
  KEYS.forEach(k => {
    const val = localStorage.getItem("thollio_" + k);
    if (val) {
      const el = document.getElementById(k);
      if (el) el.value = val;
    }
  });
  dInput.focus();
  initMap();
});

function initMap() {
  const savedLat = parseFloat(localStorage.getItem("thollio_latitude"));
  const savedLon = parseFloat(localStorage.getItem("thollio_longitude"));
  const lat = !isNaN(savedLat) ? savedLat : 51.1657;
  const lon = !isNaN(savedLon) ? savedLon : 10.4515;
  const zoom = !isNaN(savedLat) ? 15 : 7;

  map = L.map('map').setView([lat, lon], zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  marker = L.marker([lat, lon]).addTo(map);
  marker.bindPopup(`<b>üìç Standort:</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}<br>
  <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 16);
      marker.setLatLng([latitude, longitude]);
      marker.bindPopup(`<b>üìç Aktueller Standort:</b><br>${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
      <a href="https://maps.google.com/?q=${latitude},${longitude}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
      setCoords(latitude, longitude);
    });
  }

  map.on('click', e => {
    const { lat, lng } = e.latlng;
    setCoords(lat, lng);
    marker.setLatLng([lat, lng]);
    marker.bindPopup(`<b>üìç Standort:</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
    <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
  });

  setCoords(lat, lon);
}
function setCoords(lat, lon){
  document.getElementById("latitude").value = lat.toFixed(6);
  document.getElementById("longitude").value = lon.toFixed(6);
  localStorage.setItem("thollio_latitude", lat.toFixed(6));
  localStorage.setItem("thollio_longitude", lon.toFixed(6));
}

dInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v=parseFloat(dInput.value);
    if(!isNaN(v)){durchmesserListe.push(v);aktualisiereDurchschnitt();dInput.value="";}
    dInput.focus();
  }
});
function aktualisiereDurchschnitt(){
  const avg = durchmesserListe.reduce((a,b)=>a+b,0)/durchmesserListe.length;
  if(!isNaN(avg)){
    window.durchmesserDurchschnitt=avg;
    avgAnzeige.textContent="Durchschnitt: "+avg.toFixed(1)+" cm";
    document.getElementById("durchmesserListe").textContent="Eingegebene Durchmesser: "+durchmesserListe.map(d=>d.toFixed(1)).join(", ");
  }
}
function zeigeGesamtStueckzahl(){
  if(durchmesserListe.length===0){alert("Bitte mindestens einen Durchmesser eingeben.");return;}
  document.getElementById("anzahlContainer").style.display="block";
  document.getElementById("gesamtAnzahl").focus();
}

document.getElementById("holzForm").addEventListener("submit", e=>{
  e.preventDefault();
  const data={};
  KEYS.forEach(k=>{const el=document.getElementById(k);data[k]=el?el.value:"";localStorage.setItem("thollio_"+k,data[k]);});
  const laenge=parseFloat(data.laenge);
  const n=parseInt(document.getElementById("gesamtAnzahl").value);
  const d=window.durchmesserDurchschnitt;
  const einzelVol=Math.PI*Math.pow(d/200,2)*laenge;
  const gesVol=einzelVol*n;

  const tbody=document.querySelector("#ergebnisTabelle tbody");
  tbody.innerHTML=`<tr><td>${d.toFixed(1)}</td><td>${n}</td><td>${einzelVol.toFixed(3)}</td><td>${gesVol.toFixed(3)}</td></tr>`;
  document.getElementById("gesamtVolumen").textContent=gesVol.toFixed(3);
  document.getElementById("ergebnis").style.display="block";
});

function exportXLSX(){
  const wb=XLSX.utils.book_new();
  const lat=document.getElementById("latitude").value;
  const lon=document.getElementById("longitude").value;
  const mapsLink=`https://maps.google.com/?q=${lat},${lon}`;

  const ws_data=[
    ["Thollio Holzmantelerfassung"],
    ["Datum",document.getElementById("datum").value],
    ["Baumart",document.getElementById("baumart").value],
    ["Polternummer",document.getElementById("polternummer").value],
    ["Hiebnummer",document.getElementById("hiebnummer").value],
    ["Losnummer",document.getElementById("losnummer").value],
    ["L√§nge (m)",document.getElementById("laenge").value],
    ["Bemerkung",document.getElementById("bemerkung").value],
    ["Latitude",lat],["Longitude",lon],
    ["üìç Standort-Link",mapsLink],
    [],
    ["Durchschnitt (cm)","Gesamtst√ºckzahl","Einzelvolumen (m¬≥)","Gesamtvolumen (m¬≥)"]
  ];
  document.querySelectorAll("#ergebnisTabelle tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  ws_data.push(["","","Gesamtvolumen",document.getElementById("gesamtVolumen").textContent]);
  const ws1=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws1,"Erfassung");

  const ws2_data=[["Nr.","Durchmesser (cm)"]];
  durchmesserListe.forEach((d,i)=>ws2_data.push([i+1,d.toFixed(1)]));
  ws2_data.push([]);ws2_data.push(["Anzahl",durchmesserListe.length]);
  ws2_data.push(["Durchschnitt",window.durchmesserDurchschnitt.toFixed(1)]);
  const ws2=XLSX.utils.aoa_to_sheet(ws2_data);
  XLSX.utils.book_append_sheet(wb,ws2,"Durchmesserliste");

  const datum=document.getElementById("datum").value;
  const hieb=document.getElementById("hiebnummer").value||"H";
  const los=document.getElementById("losnummer").value||"L";
  const polter=document.getElementById("polternummer").value||"P";
  XLSX.writeFile(wb,`thollio_${datum}_${hieb}_${los}_${polter}.xlsx`);
}
</script>
</body>
</html>






