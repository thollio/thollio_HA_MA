<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Thollio Holzmantelerfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- XLSX f√ºr Excel-Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #1e2421;
    color: #e0e3de;
    margin: 20px;
  }

  h1 {
    text-align: center;
    color: #c4f0c2;
    margin-bottom: 25px;
  }

  form, .ergebnis {
    background: #2a2f2c;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    max-width: 900px;
    margin: 0 auto 30px auto;
  }

  label { display: block; margin-top: 10px; color: #c9d1c5; }

  input, select, textarea, button {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #555;
    margin-top: 5px;
    background-color: #3b423e;
    color: #f1f1f1;
    box-sizing: border-box;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #66bb6a;
    background-color: #454d49;
  }

  textarea { resize: vertical; min-height: 60px; }

  button {
    background-color: #36643b;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s ease;
  }

  button:hover { background-color: #2d5333; }

  #map {
    height: 300px;
    width: 100%;
    margin-top: 10px;
    border-radius: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #343b37;
  }

  th, td {
    border: 1px solid #555;
    padding: 8px;
    text-align: center;
  }

  th { background-color: #425046; color: #e4efe1; }

  .summe {
    font-weight: bold;
    background-color: #506350;
  }

  .btn-export { background-color: #245a7a; }
  .btn-export:hover { background-color: #1d495f; }

  .btn-reset { background-color: #7a2424; }
  .btn-reset:hover { background-color: #5f1d1d; }

  #durchschnittAnzeige {
    margin-top: 8px;
    font-weight: bold;
    color: #a5d6a7;
  }
</style>
</head>

<body>
<h1>Thollio Holzmantelerfassung</h1>

<form id="holzForm">

  <label>Baumart:
    <select id="baumart" required>
      <option value="">Bitte w√§hlen...</option>
      <option>Fichte</option><option>Wei√ütanne</option><option>Douglasie</option>
      <option>L√§rche</option><option>Kiefer</option><option>SNH</option><option>SLB</option>
      <option>Eiche</option><option>Buche</option><option>Ahorn</option>
      <option>Esche</option><option>Kirsche</option><option>Erle</option>
    </select>
  </label>

  <label>G√ºteklasse:
    <select id="gueteklasse" required>
      <option value="">Bitte w√§hlen...</option>
      <option>A</option><option>B</option><option>C</option><option>D</option>
      <option>BC</option><option>BK</option><option>CK</option>
      <option>CD</option><option>N</option><option>NF</option><option>K</option>
    </select>
  </label>

  <label>Polternummer:
    <input type="text" id="polternummer" required>
  </label>

  <label>Hiebnummer:
    <input type="text" id="hiebnummer" required>
  </label>

  <label>Losnummer:
    <input type="text" id="losnummer" required>
  </label>

  <label>L√§nge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <h3>Standort (OpenStreetMap)</h3>
  <div id="map"></div>
  <input type="hidden" id="latitude">
  <input type="hidden" id="longitude">

  <h3>Durchmesser eingeben (Enter nach jedem Wert)</h3>
  <input type="number" id="durchmesserEingabe" placeholder="Durchmesser (cm)" step="0.1" required>
  <div id="durchmesserListe"></div>
  <div id="durchschnittAnzeige">Durchschnitt: -</div>

  <button type="button" onclick="zeigeGesamtStueckzahl()">Gesamtst√ºckzahl eingeben</button>

  <div id="anzahlContainer" style="display:none; margin-top:20px;">
    <label>Gesamtst√ºckzahl:
      <input type="number" id="gesamtAnzahl" min="1" required>
    </label>

    <label>Bemerkung:
      <textarea id="bemerkung" placeholder="z. B. Hanglage, feucht, besch√§digt ..."></textarea>
    </label>

    <button type="submit">Berechnen</button>
  </div>

  <button type="button" class="btn-reset" onclick="allesLoeschen()">Alles l√∂schen</button>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <div id="datumAnzeige" style="margin-bottom:10px; font-weight:bold; color:#a5d6a7;"></div>
  <table id="ergebnisTabelle">
    <thead>
      <tr>
        <th>Durchschnitt (cm)</th>
        <th>Gesamtst√ºckzahl</th>
        <th>Einzelvolumen (m¬≥)</th>
        <th>Gesamtvolumen (m¬≥)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="summe">
        <td colspan="3">Gesamtvolumen</td>
        <td id="gesamtVolumen">0.000</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center; margin-top:15px;">
    <button class="btn-export" onclick="exportXLSX()">Excel (.xlsx) exportieren</button>
  </div>
</div>

<script>
let durchmesserListe = [];
let map, marker, watchId;
const dInput = document.getElementById("durchmesserEingabe");
const avgAnzeige = document.getElementById("durchschnittAnzeige");
const KEYS = ["datum","baumart","gueteklasse","polternummer","hiebnummer","losnummer","laenge","latitude","longitude","bemerkung"];

/* üå≤ Beim Laden */
window.addEventListener("load", () => {
  KEYS.forEach(k => {
    const val = localStorage.getItem("thollio_" + k);
    const el = document.getElementById(k);
    if (val && el) el.value = val;
  });

  const lastD = localStorage.getItem("thollio_lastDurchmesser");
  dInput.value = lastD ? lastD : 20;
  dInput.focus();

  initMap();
});

/* üåç Karte initialisieren und Standort fortlaufend aktualisieren */
function initMap() {
  map = L.map('map').setView([51.1657, 10.4515], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);
  marker = L.marker([51.1657, 10.4515]).addTo(map);

  if (navigator.geolocation) {
    // Startet fortlaufende Positionsaktualisierung
    watchId = navigator.geolocation.watchPosition(updatePosition, geoError, { enableHighAccuracy: true });
  } else {
    geoError();
  }

  map.on('click', e => {
    const { lat, lng } = e.latlng;
    setCoords(lat, lng);
    marker.setLatLng([lat, lng]);
    marker.bindPopup(`<b>üìç Standort:</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
    <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
  });
}

/* üîÅ Standort aktualisieren */
function updatePosition(pos){
  const { latitude, longitude } = pos.coords;
  map.setView([latitude, longitude], 16);
  marker.setLatLng([latitude, longitude]);
  marker.bindPopup(`<b>üìç Aktueller Standort:</b><br>${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
  <a href="https://maps.google.com/?q=${latitude},${longitude}" target="_blank" style="color:#90caf9;">In Google Maps √∂ffnen</a>`).openPopup();
  setCoords(latitude, longitude);
}

/* ‚ùå Fehlerbehandlung */
function geoError(){
  marker.bindPopup(`<b>üìç Standard-Standort (Deutschland):</b><br>51.1657, 10.4515`).openPopup();
  setCoords(51.1657, 10.4515);
}

/* üìç Koordinaten speichern */
function setCoords(lat, lon){
  document.getElementById("latitude").value = lat.toFixed(6);
  document.getElementById("longitude").value = lon.toFixed(6);
  localStorage.setItem("thollio_latitude", lat.toFixed(6));
  localStorage.setItem("thollio_longitude", lon.toFixed(6));
}

/* üìÖ Hilfsfunktion f√ºr aktuelles Datum */
function aktuellesDatumISO(){
  const jetzt = new Date();
  return jetzt.toISOString().split('T')[0];
}

/* üå≤ Durchmesser-Eingabe */
dInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v=parseFloat(dInput.value);
    if(!isNaN(v)){
      durchmesserListe.push(v);
      aktualisiereDurchschnitt();
      localStorage.setItem("thollio_lastDurchmesser", v);
      dInput.value=v;
      dInput.select();
    }
  }
});

function aktualisiereDurchschnitt(){
  const avg = durchmesserListe.reduce((a,b)=>a+b,0)/durchmesserListe.length;
  if(!isNaN(avg)){
    window.durchmesserDurchschnitt=avg;
    avgAnzeige.textContent="Durchschnitt: "+avg.toFixed(1)+" cm";
    document.getElementById("durchmesserListe").textContent="Eingegebene Durchmesser: "+durchmesserListe.map(d=>d.toFixed(1)).join(", ");
  }
}

function zeigeGesamtStueckzahl(){
  if(durchmesserListe.length===0){alert("Bitte mindestens einen Durchmesser eingeben.");return;}
  document.getElementById("anzahlContainer").style.display="block";
  document.getElementById("gesamtAnzahl").focus();
}

/* üìè Berechnen */
document.getElementById("holzForm").addEventListener("submit", e=>{
  e.preventDefault();
  const data={};
  KEYS.forEach(k=>{
    const el=document.getElementById(k);
    if(k==="datum"){ data[k]=aktuellesDatumISO(); }
    else { data[k]=el?el.value:""; }
    localStorage.setItem("thollio_"+k,data[k]);
  });

  const laenge=parseFloat(data.laenge);
  const n=parseInt(document.getElementById("gesamtAnzahl").value);
  const d=window.durchmesserDurchschnitt;
  const einzelVol=Math.PI*Math.pow(d/200,2)*laenge;
  const gesVol=einzelVol*n;

  document.getElementById("datumAnzeige").textContent = "üìÖ Datum: " + data.datum;

  const tbody=document.querySelector("#ergebnisTabelle tbody");
  tbody.innerHTML=`<tr><td>${d.toFixed(1)}</td><td>${n}</td><td>${einzelVol.toFixed(3)}</td><td>${gesVol.toFixed(3)}</td></tr>`;
  document.getElementById("gesamtVolumen").textContent=gesVol.toFixed(3);
  document.getElementById("ergebnis").style.display="block";
});

/* üßπ Alles l√∂schen */
function allesLoeschen() {
  if (confirm("M√∂chtest du wirklich alle Eingaben und gespeicherten Daten l√∂schen?")) {
    localStorage.clear();
    durchmesserListe = [];
    window.durchmesserDurchschnitt = undefined;
    document.getElementById("holzForm").reset();
    document.getElementById("durchmesserListe").textContent = "";
    document.getElementById("durchschnittAnzeige").textContent = "Durchschnitt: -";
    document.getElementById("ergebnis").style.display = "none";
    document.getElementById("anzahlContainer").style.display = "none";
    dInput.value = 20;
    dInput.focus();

    // Standort erneut aktiv abfragen
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(updatePosition, geoError, { enableHighAccuracy: true });
    } else {
      geoError();
    }

    alert("Alle Daten wurden gel√∂scht und der Standort wurde aktualisiert.");
  }
}

/* üì§ Excel-Export */
function exportXLSX(){
  const wb=XLSX.utils.book_new();
  const lat=document.getElementById("latitude").value;
  const lon=document.getElementById("longitude").value;
  const mapsLink=`https://maps.google.com/?q=${lat},${lon}`;
  const datum=aktuellesDatumISO();

  const ws_data=[
    ["Thollio Holzmantelerfassung"],
    ["Datum",datum],
    ["Baumart",document.getElementById("baumart").value],
    ["G√ºteklasse",document.getElementById("gueteklasse").value],
    ["Polternummer",document.getElementById("polternummer").value],
    ["Hiebnummer",document.getElementById("hiebnummer").value],
    ["Losnummer",document.getElementById("losnummer").value],
    ["L√§nge (m)",document.getElementById("laenge").value],
    ["Bemerkung",document.getElementById("bemerkung").value],
    ["Latitude",lat],["Longitude",lon],
    ["üìç Standort-Link",mapsLink],
    [],
    ["Durchschnitt (cm)","Gesamtst√ºckzahl","Einzelvolumen (m¬≥)","Gesamtvolumen (m¬≥)"]
  ];
  document.querySelectorAll("#ergebnisTabelle tbody tr").forEach(tr=>{
    ws_data.push(Array.from(tr.children).map(td=>td.textContent));
  });
  ws_data.push(["","","Gesamtvolumen",document.getElementById("gesamtVolumen").textContent]);
  const ws1=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws1,"Erfassung");

  const ws2_data=[["Nr.","Durchmesser (cm)"]];
  durchmesserListe.forEach((d,i)=>ws2_data.push([i+1,d.toFixed(1)]));
  ws2_data.push([]);ws2_data.push(["Anzahl",durchmesserListe.length]);
  ws2_data.push(["Durchschnitt",window.durchmesserDurchschnitt ? window.durchmesserDurchschnitt.toFixed(1) : "-"]);
  const ws2=XLSX.utils.aoa_to_sheet(ws2_data);
  XLSX.utils.book_append_sheet(wb,ws2,"Durchmesserliste");

  const hieb=document.getElementById("hiebnummer").value||"H";
  const los=document.getElementById("losnummer").value||"L";
  const polter=document.getElementById("polternummer").value||"P";
  XLSX.writeFile(wb,`thollio_${datum}_${hieb}_${los}_${polter}.xlsx`);
}
</script>
</body>
</html>
