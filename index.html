<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mantelholzerfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background-color: #f3f7f2; margin: 20px; color: #333; }
  h1 { text-align: center; margin-bottom: 10px; }
  form, .ergebnis { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto 30px auto; }
  label { display: block; margin-top: 10px; }
  input, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-top: 5px; box-sizing: border-box; }
  input { width: 100%; }
  button { background-color: #2c7a3f; color: white; border: none; cursor: pointer; margin-top: 15px; }
  button:hover { background-color: #256836; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #e6f0e9; }
  .summe { font-weight: bold; background-color: #d8e9d8; }
  .btn-export { background-color: #1d6fa5; }
  .btn-export:hover { background-color: #15577f; }
  #eingabeContainer { margin-top: 20px; }
  #durchmesserListe { margin-top: 10px; }
  #durchschnittAnzeige { margin-top: 5px; font-weight: bold; }
</style>
</head>
<body>
<h1>Mantelholzerfassung</h1>

<form id="holzForm">
  <label>Datum:
    <input type="date" id="datum" required>
  </label>
  <label>Revier / Standort:
    <input type="text" id="revier" placeholder="z. B. Revier Nord" required>
  </label>
  <label>Länge (m):
    <input type="number" id="laenge" step="0.01" required>
  </label>

  <div id="eingabeContainer">
    <h3>Durchmesser eingeben (Enter nach jedem Wert)</h3>
    <input type="number" id="durchmesserEingabe" placeholder="Durchmesser (cm)" step="0.1" required>
    <div id="durchmesserListe"></div>
    <div id="durchschnittAnzeige">Durchschnitt: -</div>
    <button type="button" onclick="zeigeGesamtStueckzahl()">Gesamtstückzahl eingeben</button>
  </div>

  <div id="anzahlContainer" style="display:none; margin-top:20px;">
    <h3>Gesamtstückzahl eingeben</h3>
    <label>Gesamtstückzahl: <input type="number" id="gesamtAnzahl" min="1" required></label>
    <button type="submit">Berechnen</button>
  </div>
</form>

<div class="ergebnis" id="ergebnis" style="display:none;">
  <h3>Ergebnis</h3>
  <table id="ergebnisTabelle">
    <thead>
      <tr>
        <th>Durchschnittlicher Durchmesser (cm)</th>
        <th>Gesamtstückzahl</th>
        <th>Einzelvolumen (m³)</th>
        <th>Gesamtvolumen (m³)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="summe">
        <td colspan="3">Gesamtvolumen</td>
        <td id="gesamtVolumen">0.000</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center; margin-top:15px;">
    <button class="btn-export" onclick="exportCSV()">Excel (CSV) exportieren</button>
    <button class="btn-export" onclick="exportPDF()">PDF exportieren</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let durchmesserListe = [];
const durchmesserInput = document.getElementById("durchmesserEingabe");
const durchschnittAnzeige = document.getElementById("durchschnittAnzeige");
durchmesserInput.focus();

// Enter speichert den Durchmesser, leert das Feld, berechnet Durchschnitt
durchmesserInput.addEventListener("keydown", function(e) {
  if(e.key === "Enter") {
    e.preventDefault();
    const wert = parseFloat(durchmesserInput.value);
    if(!isNaN(wert)) {
      durchmesserListe.push(wert);
      aktualisiereAnzeige();
      durchmesserInput.value = "";
    }
    durchmesserInput.focus();
  }
});

function aktualisiereAnzeige() {
  // Liste anzeigen
  document.getElementById("durchmesserListe").innerHTML = "Eingegebene Durchmesser: " + durchmesserListe.map(d => d.toFixed(1)).join(", ");
  // Durchschnitt berechnen
  const sum = durchmesserListe.reduce((a,b) => a+b,0);
  const avg = sum/durchmesserListe.length;
  window.durchmesserDurchschnitt = parseFloat(avg.toFixed(1));
  durchschnittAnzeige.textContent = "Durchschnitt: " + window.durchmesserDurchschnitt.toFixed(1);
}

function zeigeGesamtStueckzahl() {
  if(durchmesserListe.length === 0) {
    alert("Bitte mindestens einen Durchmesser eingeben.");
    return;
  }
  document.getElementById("anzahlContainer").style.display = "block";
  document.getElementById("gesamtAnzahl").focus();
}

document.getElementById("holzForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const laenge = parseFloat(document.getElementById("laenge").value);
  const datum = document.getElementById("datum").value;
  const revier = document.getElementById("revier").value;
  const gesamtAnzahl = parseInt(document.getElementById("gesamtAnzahl").value);

  if(isNaN(window.durchmesserDurchschnitt) || isNaN(gesamtAnzahl) || isNaN(laenge)) {
    alert("Bitte alle Werte korrekt eingeben.");
    return;
  }

  const einzelVol = Math.PI * Math.pow(window.durchmesserDurchschnitt/200, 2) * laenge;
  const gesVol = einzelVol * gesamtAnzahl;

  const tbody = document.querySelector("#ergebnisTabelle tbody");
  tbody.innerHTML = `<tr>
    <td>${window.durchmesserDurchschnitt.toFixed(1)}</td>
    <td>${gesamtAnzahl}</td>
    <td>${einzelVol.toFixed(3)}</td>
    <td>${gesVol.toFixed(3)}</td>
  </tr>`;

  document.getElementById("gesamtVolumen").textContent = gesVol.toFixed(3);
  document.getElementById("ergebnis").style.display = "block";
});

// Exportfunktionen
function exportCSV() {
  const date = document.getElementById("datum").value;
  const revier = document.getElementById("revier").value;
  const laenge = document.getElementById("laenge").value;
  const rows = [
    [`Datum: ${date}`, `Revier: ${revier}`, `Länge: ${laenge} m`],
    [],
    ["Durchschnittlicher Durchmesser (cm)", "Gesamtstückzahl", "Einzelvolumen (m³)", "Gesamtvolumen (m³)"]
  ];
  document.querySelectorAll("#ergebnisTabelle tbody tr").forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.textContent);
    rows.push(cols);
  });
  rows.push(["", "", "Gesamt", document.getElementById("gesamtVolumen").textContent]);
  const csv = rows.map(r => r.join(";")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `mantelholz_${date}.csv`;
  link.click();
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const date = document.getElementById("datum").value;
  const revier = document.getElementById("revier").value;
  const laenge = document.getElementById("laenge").value;

  doc.setFontSize(14);
  doc.text("Mantelholzerfassung", 14, 15);
  doc.setFontSize(10);
  doc.text(`Datum: ${date}`, 14, 22);
  doc.text(`Revier: ${revier}`, 14, 28);
  doc.text(`Länge: ${laenge} m`, 14, 34);

  let y = 45;
  doc.text("Durchschnittlicher Durchmesser (cm)   Stückzahl   Einzelvolumen (m³)   Gesamtvolumen (m³)", 14, y);
  y += 6;

  document.querySelectorAll("#ergebnisTabelle tbody tr").forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.textContent);
    doc.text(cols.join("        "), 14, y);
    y += 6;
  });

  y += 6;
  doc.text(`Gesamtvolumen: ${document.getElementById("gesamtVolumen").textContent} m³`, 14, y);

  doc.save(`mantelholz_${date}.pdf`);
}
</script>
</body>
</html>

